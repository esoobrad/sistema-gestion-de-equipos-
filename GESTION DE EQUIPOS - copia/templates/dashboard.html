<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel principal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='estilo.css') }}">
</head>
<body class="dark-bg text-light">
  <!-- HEADER -->
  <header class="container py-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo" style="height:64px">
        <div>
          <h1 class="page-title m-0">Sistema de Inventario</h1>
          <p class="page-subtitle m-0">Control central de equipos, impresoras, c√°maras y otros</p>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="/ips_disponibles" class="btn btn-outline-light">üìã IPs disponibles 192.168.3.x</a>
        <a href="/logout" class="btn btn-danger btn-pill">üîí Cerrar sesi√≥n</a>
      </div>
    </div>
  </header>

  <!-- CONTENIDO -->
  <main class="container pb-5">
    <!-- Buscador de IP general -->
    <form class="search-card dark-card p-3 mb-4" method="get" action="{{ url_for('dashboard') }}">
      <label for="ipQuery" class="form-label small text-muted">Buscador de IP</label>
      <div class="input-group">
        <input id="ipQuery" type="text" name="ip" class="form-control dark-input"
               placeholder="Ejemplo: 192.168.3.10" value="{{ ip_query or '' }}">
        <button class="btn btn-primary" type="submit">üîé Buscar</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light">‚úñ Limpiar</a>
      </div>
    </form>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-md-6 col-lg-3">
        <div class="dark-card p-3 text-center">
          <h5 class="text-muted">Equipos Activos</h5>
          <h3>{{ total_activos }}</h3>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="dark-card p-3 text-center">
          <h5 class="text-muted">Equipos Inactivos</h5>
          <h3>{{ total_inactivos }}</h3>
        </div>
      </div>
    </div>

    <!-- Atajos -->
    <div class="row g-3">
      <div class="col-md-3"><a href="/equipos" class="btn btn-outline-info w-100 p-4 fs-5">üíª Equipos</a></div>
      <div class="col-md-3"><a href="/impresoras" class="btn btn-outline-success w-100 p-4 fs-5">üñ®Ô∏è Impresoras</a></div>
      <div class="col-md-3"><a href="/camaras" class="btn btn-outline-warning w-100 p-4 fs-5">üé• C√°maras</a></div>
      <div class="col-md-3"><a href="/otros" class="btn btn-outline-primary w-100 p-4 fs-5">‚öôÔ∏è Otros</a></div>
    </div>

    <!-- Resultados b√∫squeda IP -->
    {% if resultados_ip is not none %}
      <section class="dark-card mt-4 p-3">
        <h5>Resultados para <span class="badge bg-accent">{{ ip_query }}</span></h5>

        {% set hay = (resultados_ip.equipos|length + resultados_ip.impresoras|length + resultados_ip.camaras|length + resultados_ip.otros|length) > 0 %}
        {% if not hay %}
          <p class="text-muted">No se encontraron coincidencias.</p>
        {% else %}
          {% if resultados_ip.equipos %}
            <p class="mt-2">üíª Equipos ({{ resultados_ip.equipos|length }})</p>
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle">
                <thead><tr><th>ID</th><th>Nombre</th><th>IP</th><th>Empresa</th><th></th></tr></thead>
                <tbody>
                {% for e in resultados_ip.equipos %}
                  <tr>
                    <td class="text-muted">#{{ e[0] }}</td>
                    <td>{{ e[1] }}</td>
                    <td><span class="badge bg-soft">{{ e[4] }}</span></td>
                    <td>{{ e[17] if e|length>17 else '' }}</td>
                    <td class="text-end">
                      <a href="{{ url_for('ver_equipo', id=e[0]) }}" class="btn btn-sm btn-outline-info">Abrir</a>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}

          {% if resultados_ip.impresoras %}
            <p class="mt-3">üñ®Ô∏è Impresoras ({{ resultados_ip.impresoras|length }})</p>
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle">
                <thead><tr><th>ID</th><th>Marca</th><th>Modelo</th><th>IP</th><th></th></tr></thead>
                <tbody>
                {% for p in resultados_ip.impresoras %}
                  <tr>
                    <td class="text-muted">#{{ p[0] }}</td>
                    <td>{{ p[1] }}</td>
                    <td>{{ p[2] }}</td>
                    <td><span class="badge bg-soft">{{ p[4] }}</span></td>
                    <td class="text-end">
                      <a href="{{ url_for('editar_impresora', id=p[0]) }}" class="btn btn-sm btn-outline-success">Editar</a>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}

          {% if resultados_ip.camaras %}
            <p class="mt-3">üé• C√°maras ({{ resultados_ip.camaras|length }})</p>
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle">
                <thead><tr><th>ID</th><th>Marca</th><th>Modelo</th><th>IP</th><th></th></tr></thead>
                <tbody>
                {% for c in resultados_ip.camaras %}
                  <tr>
                    <td class="text-muted">#{{ c[0] }}</td>
                    <td>{{ c[1] }}</td>
                    <td>{{ c[2] }}</td>
                    <td><span class="badge bg-soft">{{ c[4] }}</span></td>
                    <td class="text-end">
                      <a href="{{ url_for('editar_camara', id=c[0]) }}" class="btn btn-sm btn-outline-warning">Editar</a>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}

          {% if resultados_ip.otros %}
            <p class="mt-3">‚öôÔ∏è Otros ({{ resultados_ip.otros|length }})</p>
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle">
                <thead><tr><th>ID</th><th>Nombre</th><th>Marca</th><th>IP</th><th></th></tr></thead>
                <tbody>
                {% for o in resultados_ip.otros %}
                  <tr>
                    <td class="text-muted">#{{ o[0] }}</td>
                    <td>{{ o[1] }}</td>
                    <td>{{ o[2] }}</td>
                    <td><span class="badge bg-soft">{{ o[4] }}</span></td>
                    <td class="text-end">
                      <a href="{{ url_for('editar_otro', id=o[0]) }}" class="btn btn-sm btn-outline-light">Editar</a>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        {% endif %}
      </section>
    {% endif %}
  </main>

  <!-- ====== Fondo animado (Three.js + Shaders) ====== -->
  <canvas id="webgl-canvas" aria-hidden="true"></canvas>

  <!-- vertexShader -->
  <script id="js-vertex-shader" type="x-shader/x-vertex">
  attribute vec3 position;
  void main() {
    gl_Position = vec4(position, 1.0);
  }
  </script>

  <!-- fragmentShader -->
  <script id="js-fragment-shader" type="x-shader/x-fragment">
  precision highp float;
  uniform vec2 resolution;
  uniform float time;
  uniform float xScale;
  uniform float yScale;
  uniform float distortion;

  void main() {
    vec2 p = (gl_FragCoord.xy * 2.0 - resolution) / min(resolution.x, resolution.y);
    float d = length(p) * distortion;

    float rx = p.x * (1.0 + d);
    float gx = p.x;
    float bx = p.x * (1.0 - d);

    float r = 0.05 / abs(p.y + sin((rx + time) * xScale) * yScale);
    float g = 0.05 / abs(p.y + sin((gx + time) * xScale) * yScale);
    float b = 0.05 / abs(p.y + sin((bx + time) * xScale) * yScale);

    gl_FragColor = vec4(r, g, b, 1.0);
  }
  </script>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

  <script>
  class Stage {
    constructor() {
      this.renderParam = {
        clearColor: 0x0a0a0a,
        width: window.innerWidth,
        height: window.innerHeight
      };
      this.cameraParam = { left: -1, right: 1, top: 1, bottom: -1, near: 0, far: 1 };
      this.scene = null; this.camera = null; this.renderer = null;
      this.isInitialized = false;
    }
    init(){ this._setScene(); this._setRender(); this._setCamera(); this.isInitialized=true; }
    _setScene(){ this.scene = new THREE.Scene(); }
    _setRender(){
      this.renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("webgl-canvas"), antialias: true });
      this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      this.renderer.setClearColor(new THREE.Color(this.renderParam.clearColor));
      this.renderer.setSize(this.renderParam.width, this.renderParam.height, false);
    }
    _setCamera(){
      if(!this.isInitialized){
        this.camera = new THREE.OrthographicCamera(-1,1,1,-1,0,1);
      }
      const w=window.innerWidth,h=window.innerHeight;
      this.camera.updateProjectionMatrix();
      this.renderer.setSize(w,h,false);
    }
    render(){ this.renderer.render(this.scene,this.camera); }
    onResize(){ this._setCamera(); }
  }

  class MeshPlane {
    constructor(stage){
      this.stage = stage;
      this.uniforms = {
        resolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
        time:       { value: 0.0 },
        xScale:     { value: 1.2 },
        yScale:     { value: 0.55 },
        distortion: { value: 0.050 }
      };
      this.mesh=null;
    }
    init(){ this._setMesh(); }
    _setMesh(){
      const position = new Float32Array([
        -1,-1,0,  1,-1,0,  -1,1,0,
         1,-1,0, -1, 1,0,   1,1,0
      ]);
      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute("position", new THREE.BufferAttribute(position,3));
      const material = new THREE.RawShaderMaterial({
        vertexShader: document.getElementById("js-vertex-shader").textContent,
        fragmentShader: document.getElementById("js-fragment-shader").textContent,
        uniforms: this.uniforms, side: THREE.DoubleSide
      });
      this.mesh = new THREE.Mesh(geometry, material);
      this.stage.scene.add(this.mesh);
    }
    onResize(){ this.uniforms.resolution.value.set(window.innerWidth, window.innerHeight); }
    onRaf(){ this.uniforms.time.value += 0.01; }
  }

  (() => {
    const stage = new Stage(); stage.init();
    const mesh = new MeshPlane(stage); mesh.init();

    const onResize = () => { stage.onResize(); mesh.onResize(); };
    window.addEventListener("resize", onResize);

    const loop = () => { requestAnimationFrame(loop); mesh.onRaf(); stage.render(); };
    loop();
  })();
  </script>
</body>
</html>
